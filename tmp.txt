BEGIN
	
DECLARE v_pre_month_bill_sum_money INT ; -- 上月账单总额度
DECLARE v_pre_month_bill_sale_money INT;  -- 上月消费总金额
DECLARE v_pre_month_bill_pay_money INT ; --  上月还款总金额
DECLARE v_pre_month_not_pay_bill_money  INT;  -- 上月欠款总金额

DECLARE v_cur_month_bill_sum_money INT ; --   当月账单总额度
DECLARE v_cur_month_bill_sale_money INT;  -- 当月消费总金额
DECLARE v_cur_month_bill_pay_money INT ; --   当月还款总金额
DECLARE v_cur_month_not_pay_bill_money  INT;  --  当月欠款总金额

DECLARE  v_billDATE  INT; -- 账单日
DECLARE  v_credit_bill_date_count INT; -- 账单日信用卡数量

DECLARE  v_pre_bill_sum_money	INT ; -- 前一个帐号总金额

DECLARE v_current_sale_sum_money INT; -- 当前消费总金额
DECLARE v_current_pay_sum_money	INT; -- 当前还款总金额

DECLARE v_bill_count  INT; -- 每张信用卡的账单数量
DECLARE v_bill_sale_rate DOUBLE; -- 账单消费比率(总金额的70%-80%)

DECLARE v_bill_credit_no VARCHAR(30); -- 信用卡号

DECLARE v_pre_bill_date DATE;  -- 前一个月帐号日


DECLARE  v_current_bill_day DATE; --  当前日期
DECLARE v_next_bill_day DATE;	-- 下一个账单日期

DECLARE v_bill_sum_days  INT; -- 账单总天数

DECLARE v_credit_no  VARCHAR(30); --  信用卡编号


DECLARE i INT;
DECLARE dayCount  INT;

DECLARE v_day_count  INT;
DECLARE v_sale_day DATE;


SELECT  DAYOFMONTH( DATE_FORMAT(NOW(),'%Y-%m-%d %h:%i:%s')) into v_billDATE ; 

select date_format(now(),'%y-%m-%d') into v_current_bill_day;
select date_format(date_add(NOW(), interval 1 MONTH),'%y-%m-%d')  into  v_next_bill_day;


SELECT   v_next_bill_day - v_current_bill_day INTO   v_bill_sum_days;


SELECT count(1) INTO v_credit_bill_date_count   FROM CREDITCARD  F where f.billDate=v_billDate;

select date_add(NOW(), interval 1 MONTH) ; --  获取下一个月的今天

select date_sub(NOW(), interval  1 MONTH);  -- 获取上一个月的今天

SEt dayCount=30;

if v_credit_bill_date_count >0 then
	
SELECT *   FROM CREDITCARD  F where f.billDate=v_billDate;

SET v_credit_no='C001';

loop_label:  LOOP
 SET i=i+1;
	IF  v_day_count>i then
		select DATE_ADD(now(), Interval +i day) INTO  v_sale_day;
			if f_check_sale_day(i) =1  then 
			
				INSERT INTO Plan(crditId,saleDate,outmoney) VALUES(i,iv_sale_day,100);
		
			else 
			
				INSERT INTO Plan(crditId,saleDate,outmoney) VALUES(i,iv_sale_day,0);
		
			end if;

	END IF;

	if i>dayCount then 
	LEAVE loop_label;
	end if;
	
END LOOP loop_label;


end if;

if v_credit_bill_date_count  is null then 

SELECT *   FROM CREDITCARD  F where f.billDate=v_billDate;
end if;


COMMIT;

   END